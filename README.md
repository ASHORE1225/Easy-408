#  åœ¨äººå·¥æ™ºèƒ½é£é€Ÿå‘å±•çš„å½“ä¸‹ï¼ŒåŸºäº LlamaIndex ä¸ InternLM RAG æŠ€æœ¯æ‰“é€ çš„ 408 é—®é¢˜å›ç­”ç³»ç»Ÿï¼Œä¸ºè®¡ç®—æœºä¸“ä¸šè€ƒç ”å­¦ç”Ÿä»¥åŠç›¸å…³çŸ¥è¯†çš„å­¦ä¹ è€…ï¼Œå¼€å¯äº†ä¸€åœºåˆ«å¼€ç”Ÿé¢çš„å­¦ä¹ ä¹‹æ—…ã€‚æ­¤ç³»ç»Ÿå®Œç¾èåˆäº† LlamaIndex å“è¶Šçš„ç´¢å¼•æ„å»ºèƒ½åŠ›ä¸é«˜æ•ˆçš„æ•°æ®ç»„ç»‡èƒ½åŠ›ï¼Œæ­é…åŸºäº InternLM æ¨¡å‹çš„æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰æŠ€æœ¯ï¼Œå ªç§°ç è”ç’§åˆã€‚LlamaIndex èƒ½å¤Ÿæœ‰æ¡ä¸ç´Šåœ°å°†æµ·é‡ 408 è€ƒç ”æ ¸å¿ƒçŸ¥è¯†ï¼Œåƒæ•°æ®ç»“æ„é‡Œå¤æ‚çš„ç®—æ³•é€»è¾‘ã€è®¡ç®—æœºç»„æˆåŸç†ä¸­ç²¾å¦™çš„ç¡¬ä»¶æ¶æ„ã€æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹ç®¡ç†æœºåˆ¶ï¼Œä»¥åŠè®¡ç®—æœºç½‘ç»œçš„åè®®ä½“ç³»ç­‰ï¼Œç²¾å¿ƒæ„å»ºæˆä¸€å¥—æ¡ç†æ¸…æ™°ã€æ˜“äºå¿«é€Ÿæ£€ç´¢çš„ç´¢å¼•ç»“æ„ã€‚è€Œ InternLM RAG æŠ€æœ¯æ›´æ˜¯é”¦ä¸Šæ·»èŠ±ï¼Œåœ¨ç”Ÿæˆå›ç­”å†…å®¹æ—¶ï¼Œèƒ½ç²¾å‡†å…³è”ä»ç´¢å¼•åº“ä¸­æå–çš„ç›¸å…³çŸ¥è¯†ç‚¹ï¼Œä»è€Œè®©è¾“å‡ºçš„ç­”æ¡ˆå…¼å…·å‡†ç¡®æ€§ä¸ä¸“ä¸šæ€§ã€‚å½“ç”¨æˆ·è¾“å…¥ 408 ç›¸å…³é—®é¢˜åï¼Œç³»ç»Ÿä¼šå³åˆ»å¯åŠ¨ã€‚LlamaIndex å¦‚åŒä¸€ä½è®­ç»ƒæœ‰ç´ çš„æœç´¢ä¸“å®¶ï¼Œè¿…é€Ÿä»åºå¤§çš„çŸ¥è¯†å‚¨å¤‡ä¸­å®šä½å‡ºæœ€å¥‘åˆçš„å†…å®¹ç‰‡æ®µï¼Œç´§æ¥ç€ InternLM RAG æ¨¡å‹ä»¥è¿™äº›ç‰‡æ®µä¸ºåŸºçŸ³ï¼Œç²¾å¿ƒé›•ç¢å‡ºç²¾å‡†ã€è¯¦å°½ä¸”æ¡ç†åˆ†æ˜çš„å›ç­”ã€‚æ— è®ºæ˜¯å¯¹æ•°æ®ç»“æ„ä¸­å¤æ‚ç®—æ³•çš„æ·±åº¦å‰–æï¼Œè¿˜æ˜¯å¯¹è®¡ç®—æœºç»„æˆåŸç†é‡Œæ™¦æ¶©æ¦‚å¿µçš„é€šä¿—è§£è¯»ï¼Œè¯¥ç³»ç»Ÿéƒ½èƒ½åº”å¯¹è£•å¦‚ã€‚è¿™ä¸€åˆ›æ–°çš„ 408 é—®é¢˜å›ç­”ç³»ç»Ÿï¼Œä¸å•å•æ˜¯ä¸€æ¬¾ä¾¿æ·çš„ç­”ç–‘å·¥å…·ï¼Œæ›´åƒæ˜¯ä¸€ä½å¦‚å½±éšå½¢çš„å­¦ä¹ å¯¼å¸ˆï¼ŒåŠ©åŠ›å­¦ä¹ è€…é€å½»ç†è§£ä¸“ä¸šçŸ¥è¯†ï¼Œå¤§å¹…æé«˜å­¦ä¹ æ•ˆç‡ï¼Œæ— ç–‘æ˜¯è®¡ç®—æœºä¸“ä¸šå­¦ä¹ é“è·¯ä¸Šä¸å¯æˆ–ç¼ºçš„å¾—åŠ›ä¼™ä¼´ã€‚


## 1. å‰ç½®

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/ffada5ae8c84403e963d83dd98559298.jpeg#pic_center)


LlamaIndex æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡å¢å¼ºçš„ LLM æ¡†æ¶ï¼Œæ—¨åœ¨é€šè¿‡å°†å…¶ä¸ç‰¹å®šä¸Šä¸‹æ–‡æ•°æ®é›†é›†æˆï¼Œå¢å¼ºå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰çš„èƒ½åŠ›ã€‚å®ƒå…è®¸æ‚¨æ„å»ºåº”ç”¨ç¨‹åºï¼Œæ—¢åˆ©ç”¨ LLMs çš„ä¼˜åŠ¿ï¼Œåˆèå…¥æ‚¨çš„ç§æœ‰æˆ–é¢†åŸŸç‰¹å®šä¿¡æ¯ã€‚
### RAG æ•ˆæœæ¯”å¯¹

å¦‚å›¾æ‰€ç¤ºï¼Œ `æµ¦è¯­ API ` è®­ç»ƒæ•°æ®åº“ä¸­å¹¶æ²¡æœ‰æ”¶å½•åˆ°408çš„ç›¸å…³ä¿¡æ¯ã€‚å·¦å›¾ä¸­é—®ç­”å‡æœªç»™å‡ºå‡†ç¡®çš„ç­”æ¡ˆã€‚å³å›¾æœªå¯¹ `æµ¦è¯­ API ` è¿›è¡Œä»»ä½•å¢è®­çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ RAG æŠ€æœ¯å®ç°çš„æ–°å¢çŸ¥è¯†é—®ç­”ã€‚
åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/3d4bdd5f141444ae9a8fed8b9d14d0dc.jpeg#pic_center)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/d4da806e1ac34959add7a5865de3484e.jpeg#pic_center)

## 2. ç¯å¢ƒã€æ¨¡å‹å‡†å¤‡

### 2.1 é…ç½®åŸºç¡€ç¯å¢ƒ
è¿™é‡Œä»¥åœ¨è¶‹åŠ¿äº‘æœåŠ¡å™¨ä¸Šéƒ¨ç½²LlamaIndexä¸ºä¾‹ã€‚


é¦–å…ˆã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/8162dbbf405a49c49b2b28cae0fac138.jpeg#pic_center)


è¿›å…¥å¼€å‘æœºåï¼Œåˆ›å»ºæ–°çš„condaç¯å¢ƒï¼Œå‘½åä¸º `llamaindex`ï¼Œåœ¨å‘½ä»¤è¡Œæ¨¡å¼ä¸‹è¿è¡Œï¼š
```bash
conda create -n llamaindex python=3.10
```
å¤åˆ¶å®Œæˆåï¼Œåœ¨æœ¬åœ°æŸ¥çœ‹ç¯å¢ƒã€‚
```bash
conda env list
```
ç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚
```bash
# conda environments:
#
base                  *  /root/.conda
llamaindex               /root/.conda/envs/llamaindex
```

è¿è¡Œ `conda` å‘½ä»¤ï¼Œæ¿€æ´» `llamaindex` ç„¶åå®‰è£…ç›¸å…³åŸºç¡€ä¾èµ–
**python** è™šæ‹Ÿç¯å¢ƒ:
```bash
conda activate llamaindex
```
**å®‰è£…python ä¾èµ–åŒ…**
```bash
pip install einops==0.7.0 protobuf==5.26.1
```

### 2.2 å®‰è£… Llamaindex
å®‰è£… Llamaindexå’Œç›¸å…³çš„åŒ…
```bash
conda activate llamaindex
pip install llama-index==0.11.20
pip install llama-index-llms-replicate==0.3.0
pip install llama-index-llms-openai-like==0.2.0
pip install llama-index-embeddings-huggingface==0.3.1
pip install llama-index-embeddings-instructor==0.2.1
pip install torch==2.5.0 torchvision==0.20.0 torchaudio==2.5.0 --index-url https://download.pytorch.org/whl/cu121
```

### 2.3 ä¸‹è½½ Sentence Transformer æ¨¡å‹

æºè¯å‘é‡æ¨¡å‹ [Sentence Transformer](https://huggingface.co/sentencetransformers/paraphrase-multilingual-MiniLM-L12-v2):ï¼ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰ç”¨åˆ«çš„å¼€æºè¯å‘é‡æ¨¡å‹æ¥è¿›è¡Œ Embeddingï¼Œç›®å‰é€‰ç”¨è¿™ä¸ªæ¨¡å‹æ˜¯ç›¸å¯¹è½»é‡ã€æ”¯æŒä¸­æ–‡ä¸”æ•ˆæœè¾ƒå¥½çš„ï¼ŒåŒå­¦ä»¬å¯ä»¥è‡ªç”±å°è¯•åˆ«çš„å¼€æºè¯å‘é‡æ¨¡å‹ï¼‰

https://modelscope.cn/models/Ceceliachenen/paraphrase-multilingual-MiniLM-L12-v2/summary

```
git lfs install

cd /root/model/

git clone https://www.modelscope.cn/Ceceliachenen/paraphrase-multilingual-MiniLM-L12-v2.git

mv paraphrase-multilingual-MiniLM-L12-v2 sentence-transformer
```


### 2.4 ä¸‹è½½ NLTK ç›¸å…³èµ„æº
æˆ‘ä»¬åœ¨ä½¿ç”¨å¼€æºè¯å‘é‡æ¨¡å‹æ„å»ºå¼€æºè¯å‘é‡çš„æ—¶å€™ï¼Œéœ€è¦ç”¨åˆ°ç¬¬ä¸‰æ–¹åº“ `nltk` çš„ä¸€äº›èµ„æºã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå…¶ä¼šè‡ªåŠ¨ä»äº’è”ç½‘ä¸Šä¸‹è½½ï¼Œä½†å¯èƒ½ç”±äºç½‘ç»œåŸå› ä¼šå¯¼è‡´ä¸‹è½½ä¸­æ–­ï¼Œæ­¤å¤„æˆ‘ä»¬å¯ä»¥ä»å›½å†…ä»“åº“é•œåƒåœ°å€ä¸‹è½½ç›¸å…³èµ„æºï¼Œä¿å­˜åˆ°æœåŠ¡å™¨ä¸Šã€‚
æˆ‘ä»¬ç”¨ä»¥ä¸‹å‘½ä»¤ä¸‹è½½ nltk èµ„æºå¹¶è§£å‹åˆ°æœåŠ¡å™¨ä¸Šï¼š
```bash
cd /root
git clone https://gitee.com/yzy0612/nltk_data.git  --branch gh-pages
cd nltk_data
mv packages/*  ./
cd tokenizers
unzip punkt.zip
cd ../taggers
unzip averaged_perceptron_tagger.zip
```
ä¹‹åä½¿ç”¨æ—¶æœåŠ¡å™¨å³ä¼šè‡ªåŠ¨ä½¿ç”¨å·²æœ‰èµ„æºï¼Œæ— éœ€å†æ¬¡ä¸‹è½½

## 3. æ˜¯å¦ä½¿ç”¨ LlamaIndex å‰åå¯¹æ¯”

### 3.1 ä¸ä½¿ç”¨ LlamaIndex RAGï¼ˆä»…APIï¼‰
```python
test_internlm.py
from openai import OpenAI

base_url = "https://internlm-chat.intern-ai.org.cn/puyu/api/v1/"
api_key = "eyJ0XBlIjoiSldUIiwiYWxnIjoiSFM1MTIifQ.eyJqdGkiOiIwMDE4NjAiLCJyb2wiOiJST0xFX1JFR0lTVEVSIiwiaXNzIjoiT3BlblhMYWIiLCJpYXQiOjE3MzI5NDAzNTksImNsaWVudElkIjoiZWJtcnZvZDZ5bzBubHphZWsxeXiLCJwaGuZSI6IjE2NjkyODYwODQ1IiwidXVpZCI6IjI2YjE3Mzg4LWI1OTktNGQ3OS1iZmQyLWMyNDVmZTE4MjA0NiIsImVtYWlsIjoiemhhb3Fpc2hlbmcyMDIxQG91dGxvb2suY29tIiwiZXhwIjoxNzQ4NDkyMzU5fQ.SFn88Qa2OuVH24Frivyo_rRyFjVZx32yPWwr0VLiBx45iRK7VZdWiTQR4Rt4OSo2DGAURghUxEu7LnViv6TGA"
model="internlm2.5-latest"

# base_url = "https://api.siliconflow.cn/v1"
# api_key = "sk-è¯·å¡«å†™å‡†ç¡®çš„ tokenï¼"
# model="internlm/internlm2_5-7b-chat"

client = OpenAI(
    api_key=api_key , 
    base_url=base_url,
)

chat_rsp = client.chat.completions.create(
    model=model,
    messages=[{"role": "user", "content": "408æ˜¯ä»€ä¹ˆï¼Ÿ"}],
)

for choice in chat_rsp.choices:
    print(choice.message.content)
```
ç»“æœ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/61d7a3c85610492abd597e15d41b4714.jpeg#pic_center)

### 3.2 ä½¿ç”¨ API+LlamaIndex 

```python
import os 
os.environ['NLTK_DATA'] = '/root/nltk_data'

from llama_index.core import VectorStoreIndex, SimpleDirectoryReader
from llama_index.core.settings import Settings
from llama_index.embeddings.huggingface import HuggingFaceEmbedding
from llama_index.legacy.callbacks import CallbackManager
from llama_index.llms.openai_like import OpenAILike


# Create an instance of CallbackManager
callback_manager = CallbackManager()

api_base_url =  "https://internlm-chat.intern-ai.org.cn/puyu/api/v1/"
model = "internlm2.5-latest"
api_key = "eyJ0eXBlIjoiSldUIiwiYWxnIjoiSFM1MTIifQ.eyJqdGkiOiIwMDE4NjAiLCJyb2wiOiJST0xFX1JFR0lTVEVSIiwiaXNzIjoiT3BlblhMYWIipYXQiOjE3MzI5NDAzNTksImNsaWVudElkIjoiZWJtcnZvZDZ5bzBubHphZWsxeXAiLCJwaG9uZSI6IjE2NjkyODYwODQ1IiwidXVpZCI6IjI2YjE3Mzg4LWI1OTktNGQ3OS1iZmQyLWMyNDVmZTE4MjA0NiIsImVtYWlsiemhhb3Fpc2hlbmcyMDIxQG91dGxvb2suY29tIiwiZXhwIjoxNzQ4NDkyMzU5fQ.SFn88Qa72OuVH24Frivyo_rRyFjVZx32yPWwr0VLiBx45iRK7VZdWiTQR4Rt4OSo2DGAURghUxEu7LnViv6TGA"




llm =OpenAILike(model=model, api_base=api_base_url, api_key=api_key, is_chat_model=True,callback_manager=callback_manager)


embed_model = HuggingFaceEmbedding(

    model_name="/root/model/sentence-transformer"
)



Settings.llm = llm

documents = SimpleDirectoryReader("/root/llamaindex_demo/data").load_data()
index = VectorStoreIndex.from_documents(documents)
response = query_engine.query("408æ˜¯ä»€ä¹ˆ?")

print(response)
```
ç»“æœ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/3e595ab626274af5a64fa1e35199c7da.jpeg#pic_center)


## 4. LlamaIndex web
è¿è¡Œä¹‹å‰é¦–å…ˆå®‰è£…ä¾èµ–

```shell
pip install streamlit==1.39.0
```

è¿è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œæ–°å»ºä¸€ä¸ªpythonæ–‡ä»¶

```python
import streamlit as st
from llama_index.core import VectorStoreIndex, SimpleDirectoryReader, Settings
from llama_index.embeddings.huggingface import HuggingFaceEmbedding
from llama_index.legacy.callbacks import CallbackManager
from llama_index.llms.openai_like import OpenAILike

# Create an instance of CallbackManager
callback_manager = CallbackManager()

api_base_url =  "https://internlm-chat.intern-ai.org.cn/puyu/api/v1/"
model = "internlm2.5-latest"
api_key = "eyJ0eXBlIjoiSldUwiYWxnIjoiSFM1MTIifQ.SFn88Qa72OuVH24Frivyo_rRyFjVZx32yPWwr0VLiBx45iRK7VZdWiTQR4Rt4OSo2DGAURghUxEu7LnViv6TGA"


llm =OpenAILike(model=model, api_base=api_base_url, api_key=api_key, is_chat_model=True,callback_manager=callback_manager)



st.set_page_config(page_title="llama_index_demo", page_icon="ğŸ¦œğŸ”—")
st.title("llama_index_demo")

# åˆå§‹åŒ–æ¨¡å‹
@st.cache_resource
def init_models():
    embed_model = HuggingFaceEmbedding(
        model_name="/root/model/sentence-transformer"
    )
    Settings.embed_model = embed_model

    #ç”¨åˆå§‹åŒ–llm
    Settings.llm = llm

    documents = SimpleDirectoryReader("/root/llamaindex_demo/data").load_data()
    index = VectorStoreIndex.from_documents(documents)
    query_engine = index.as_query_engine()

    return query_engine

# æ£€æŸ¥æ˜¯å¦éœ€è¦åˆå§‹åŒ–æ¨¡å‹
if 'query_engine' not in st.session_state:
    st.session_state['query_engine'] = init_models()

def greet2(question):
    response = st.session_state['query_engine'].query(question)
    return response

      
# Store LLM generated responses
if "messages" not in st.session_state.keys():
    st.session_state.messages = [{"role": "assistant", "content": "ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"}]    

    # Display or clear chat messages
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.write(message["content"])

def clear_chat_history():
    st.session_state.messages = [{"role": "assistant", "content": "ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"}]

st.sidebar.button('Clear Chat History', on_click=clear_chat_history)

# Function for generating LLaMA2 response
def generate_llama_index_response(prompt_input):
    return greet2(prompt_input)

# User-provided prompt
if prompt := st.chat_input():
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.write(prompt)

# Gegenerate_llama_index_response last message is not from assistant
if st.session_state.messages[-1]["role"] != "assistant":
    with st.chat_message("assistant"):
        with st.spinner("Thinking..."):
            response = generate_llama_index_response(prompt)
            placeholder = st.empty()
            placeholder.markdown(response)
    message = {"role": "assistant", "content": response}
    st.session_state.messages.append(message)
```

ä¹‹åè¿è¡Œ
```bash
streamlit run app.py
```

ç»“æœ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/1cb3d719c87844a0a6a4634378715a73.jpeg#pic_center)
